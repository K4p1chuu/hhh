<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baza Danych Pojazdów - MDT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .sortable:hover { cursor: pointer; background-color: #374151; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen">

    <aside id="sidebar-container" class="w-64 bg-gray-800 p-4 flex flex-col min-h-screen flex-shrink-0"></aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <h1 class="text-3xl font-bold text-white mb-6">Baza Danych Pojazdów</h1>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6">
            <div class="flex items-center space-x-4">
                <input type="text" id="search-input" class="flex-grow bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Filtruj po numerze rejestracyjnym...">
                <button id="refresh-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-lg flex items-center" title="Odśwież listę">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <div id="table-container" class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
             <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                        <tr>
                            <th class="px-6 py-3">Rejestracja</th>
                            <th class="px-6 py-3">Pojazd</th>
                            <th class="px-6 py-3">Właściciel</th>
                            <th id="sort-date" class="px-6 py-3 sortable">Data Rejestracji <i data-lucide="arrow-down-up" class="inline w-3 h-3 ml-1"></i></th>
                        </tr>
                    </thead>
                    <tbody id="vehicles-table-body">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="message-container" class="text-center py-10"></div>
    </main>
    
    <script src="shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userData = await loadSidebarAndUserData('vehicle-database');
            if(!userData) return;
            
            lucide.createIcons();

            const token = localStorage.getItem('mdt-token');
            const searchInput = document.getElementById('search-input');
            const tableBody = document.getElementById('vehicles-table-body');
            const messageContainer = document.getElementById('message-container');
            const refreshButton = document.getElementById('refresh-button');
            const sortDateButton = document.getElementById('sort-date');

            let allVehicles = [];
            let dateSortDirection = 'desc'; 

            async function loadAndRenderVehicles() {
                messageContainer.innerHTML = '<p class="text-gray-500">Ładowanie danych...</p>';
                tableBody.innerHTML = '';
                try {
                    const response = await fetch('/api/vehicles', { headers: { 'Authorization': token } });
                    if (!response.ok) throw new Error('Błąd odpowiedzi serwera');
                    
                    allVehicles = await response.json();
                    renderTable();
                    return allVehicles.length;

                } catch (error) {
                    console.error("Błąd ładowania pojazdów:", error);
                    messageContainer.innerHTML = '<p class="text-red-500">Nie udało się załadować bazy pojazdów.</p>';
                    return 0;
                }
            }
            
            function renderTable() {
                allVehicles.sort((a, b) => {
                    const dateA = new Date(a.registeredAt);
                    const dateB = new Date(b.registeredAt);
                    return dateSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                });
                
                tableBody.innerHTML = ''; 
                const filterText = searchInput.value.toLowerCase();

                const filteredVehicles = allVehicles.filter(vehicle => 
                    vehicle.plate && vehicle.plate.toLowerCase().includes(filterText)
                );

                if (filteredVehicles.length === 0) {
                     if (allVehicles.length > 0) {
                        messageContainer.innerHTML = '<p class="text-gray-500">Nie znaleziono pasujących pojazdów.</p>';
                    } else {
                        messageContainer.innerHTML = '<p class="text-gray-500">Baza pojazdów jest pusta. Upewnij się, że bot odczytał nowe rejestracje.</p>';
                    }
                } else {
                    messageContainer.innerHTML = '';
                }

                filteredVehicles.forEach((vehicle, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-mono text-blue-400">${vehicle.plate}</td>
                        <td class="px-6 py-4">${vehicle.make || ''} ${vehicle.model || ''}</td>
                        <td class="px-6 py-4">${vehicle.ownerName || 'Brak danych'}</td>
                        <td class="px-6 py-4">${new Date(vehicle.registeredAt).toLocaleString('pl-PL')}</td>
                    `;
                    tableBody.appendChild(row);
                });
                lucide.createIcons();
            }

            searchInput.addEventListener('input', renderTable);
            sortDateButton.addEventListener('click', () => {
                dateSortDirection = dateSortDirection === 'asc' ? 'desc' : 'asc';
                renderTable();
            });

            refreshButton.addEventListener('click', async () => {
                const icon = refreshButton.querySelector('i');
                icon.classList.add('animate-spin');
                const count = await loadAndRenderVehicles();
                setTimeout(() => icon.classList.remove('animate-spin'), 500);
            });

            loadAndRenderVehicles();
        });
    </script>
</body>
</html>

